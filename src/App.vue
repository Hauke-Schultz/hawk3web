<script setup>
import {onMounted, watch} from 'vue'
import { useRouter } from 'vue-router'
import { useLocalStorage } from './gamingHub/composables/useLocalStorage.js'
import { useI18n } from './composables/useI18n.js'
import { useBadge } from './composables/useBadge.js'
import InstallPrompt from './components/InstallPrompt.vue'

// Services
const { setBadge, badgeSupported } = useBadge()
const { gameData, updateNotificationCount, updateSettings, checkAutoAchievements, getCurrentLanguage } = useLocalStorage()
const { t, setLanguage } = useI18n()
const router = useRouter()

// Theme handling
const handleThemeChange = (newTheme) => {
	updateSettings({ theme: newTheme })
	document.documentElement.setAttribute('data-theme', newTheme)
}

const handleLanguageChange = async (newLanguage) => {
	const success = await setLanguage(newLanguage)
	if (success) {
		updateSettings({ language: newLanguage })
		document.documentElement.setAttribute('lang', newLanguage)
	}
}

const handleFontSizeChange = (newFontSize) => {
	updateSettings({ fontSize: newFontSize })
	document.documentElement.setAttribute('data-font-size', newFontSize)
}

// Navigation handlers using router
const handleBackToHome = () => {
	router.push('/')
}

const handleSettingsClick = () => {
	router.push('/settings')
}

const handleProfileClick = () => {
	router.push('/profile')
}

const handleShopClick = () => {
	router.push('/shop')
}

const handleTrophyClick = () => {
	router.push('/trophies')
}

const handleMenuClick = () => {
	router.push('/')
}

// Lifecycle
onMounted(async () => {
	document.documentElement.setAttribute('data-theme', gameData.settings.theme)

	if (badgeSupported.value) {
		console.log('ðŸ”” Badge API supported!')

		// Initial badge count setzen
		const count = updateNotificationCount()
		await setBadge(count)

		console.log(`ðŸ”” Initial badge count: ${count}`)
	} else {
		console.log('ðŸ”” Badge API not supported on this device')
	}

	const storedLanguage = getCurrentLanguage()
	await setLanguage(storedLanguage)
	const storedFontSize = gameData.settings.fontSize || 'medium'
	document.documentElement.setAttribute('lang', storedLanguage)
	document.documentElement.setAttribute('data-font-size', storedFontSize)

	checkAutoAchievements()
})

watch(() => gameData.notifications.unreadCount, async (newCount, oldCount) => {
	if (badgeSupported.value && newCount !== oldCount) {
		await setBadge(newCount)
		console.log(`ðŸ”” Badge updated: ${oldCount} â†’ ${newCount}`)
	}
}, { immediate: true })
</script>

<template>
	<div class="container" :class="gameData.settings.theme" role="application">
		<router-view
			:player-profile="gameData.player"
			:current-theme="gameData.settings.theme"
			@profile-click="handleProfileClick"
			@trophy-click="handleTrophyClick"
			@settings-click="handleSettingsClick"
			@shop-click="handleShopClick"
			@theme-change="handleThemeChange"
			@language-change="handleLanguageChange"
			@font-size-change="handleFontSizeChange"
			@menu-click="handleMenuClick"
			@back-to-home="handleBackToHome"
		/>
		<!-- PWA Install Prompt -->
		<InstallPrompt />
	</div>
</template>

<style lang="scss">
#app {
	margin: 0 auto;
	display: flex;
	justify-content: center;
}

.container {
	min-height: 100vh;
	font-family: var(--font-family-base), sans-serif;
	background-color: var(--bg-color);
	color: var(--text-color);
	transition: background-color 0.3s, color 0.3s;
	display: flex;
	flex-direction: column;
	position: relative;
	width: var(--content-width);
}

.content {
	padding: var(--space-4) 0;
	max-width: var(--content-width);
	margin: 0 auto;
	width: 100%;
	display: flex;
	flex-direction: column;
	align-items: stretch;
	justify-content: flex-start;
	gap: var(--space-4);

	&:focus {
		outline: none;
	}
}
</style>